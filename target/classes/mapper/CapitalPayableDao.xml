<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xingji.frameproject.mybatis.dao.CapitalPayableDao">

    <resultMap type="com.xingji.frameproject.mybatis.entity.CapitalPayable" id="CapitalPayableMap">
        <result property="deliveryId" column="delivery_id" jdbcType="VARCHAR"/>
        <result property="deliveryTime" column="delivery_time" jdbcType="TIMESTAMP"/>
        <result property="vendor" column="vendor_name" jdbcType="VARCHAR"/>
        <result property="buyer" column="buyer" jdbcType="VARCHAR"/>
        <result property="payables" column="payables" jdbcType="NUMERIC"/>
        <result property="paid" column="paid" jdbcType="NUMERIC"/>
        <result property="unpaid" column="unpaid" jdbcType="NUMERIC"/>
        <result property="remarks" column="remarks" jdbcType="VARCHAR"/>
        <result property="founder" column="founder" jdbcType="VARCHAR"/>
        <result property="caseState" column="case_state" jdbcType="INTEGER"/>
        <result property="paymentRemark" column="payment_remark" jdbcType="VARCHAR"/>
        <result property="lastCollectionTime" column="last_collection_time" jdbcType="TIMESTAMP"/>
    </resultMap>
    <resultMap id="PurchaseCapital" type="com.xingji.frameproject.vo.PurchaseCapitalVo">
        <result property="purchaseId" column="delivery_id" jdbcType="VARCHAR"/>
        <result property="purchaseTime" column="delivery_time" jdbcType="TIMESTAMP"/>
        <result property="unpaidMoney" column="unpaid" jdbcType="NUMERIC"/>
        <result property="paidMoney" column="paid" jdbcType="NUMERIC"/>
        <result property="payableMoney" column="payables" jdbcType="NUMERIC"/>
        <result property="vendor" column="vendor" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="CiaBill" type="com.xingji.frameproject.vo.CiaBillVo">
        <result property="saleId" column="delivery_id" jdbcType="VARCHAR"/>
        <result property="saleTime" column="delivery_time" jdbcType="TIMESTAMP"/>
        <result property="notMoney" column="unpaid" jdbcType="NUMERIC"/>
        <result property="alreadyMoney" column="paid" jdbcType="NUMERIC"/>
        <result property="shouldMoney" column="payables" jdbcType="NUMERIC"/>
        <result property="otherParty" column="vendor" jdbcType="VARCHAR"/>
    </resultMap>
    <!--查询单个-->
    <select id="queryById" resultMap="CapitalPayableMap">
        select
          delivery_id, delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder, case_state, payment_remark, last_collection_time
        from frameproject.capital_payable
        where delivery_id = #{deliveryId}
    </select>
    <!--修改订单已收款-->
    <update id="paidadd">
        update capital_payable
        <set>
            <if test="paymentRemark != null and paymentRemark != ''">
                payment_remark = #{paymentRemark},
            </if>
            <if test="lastCollectionTime != null">
                last_collection_time = #{lastCollectionTime},
            </if>
            <if test="paid != null">
                paid = paid + #{paid},
                unpaid = payables - paid
            </if>
        </set>
        where delivery_id = #{deliveryId}
    </update>

    <!--查询本次付款-->
    <select id="querythisPayment" resultMap="PurchaseCapital">
        select * from capital_payable where delivery_id=#{purchaseId}
    </select>
    <!--查询所有可付款-->
    <select id="queryPayment" resultMap="PurchaseCapital">
        select * from capital_payable
        <where>
            case_state=0
            <if test="purchaseId != null and purchaseId != ''">
                and delivery_id like CONCAT('%',#{purchaseId},'%')
            </if>
            <if test="vendor != null and vendor != ''">
                and vendor = #{vendor}
            </if>
        </where>
    </select>
    <select id="querycavPayment" resultMap="CiaBill">
        select * from capital_payable
        <where>
            case_state=0
            <if test="saleId != null and saleId != ''">
                and delivery_id like CONCAT('%',#{saleId},'%')
            </if>
            <if test="otherParty != null and otherParty != ''">
                and vendor = #{otherParty}
            </if>
        </where>
    </select>
    <!--查询指定行数据-->
    <select id="queryAllByLimit" resultMap="CapitalPayableMap">
        select
          delivery_id, delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder, case_state, payment_remark, last_collection_time
        from frameproject.capital_payable
        limit #{offset}, #{limit}
    </select>

    <!--通过实体作为筛选条件查询-->
    <select id="queryAll" resultMap="CapitalPayableMap">
        select
        delivery_id, delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder, case_state, payment_remark,
        last_collection_time
        from frameproject.capital_payable
        <where>
            <if test="deliveryId != null and deliveryId != ''">
                and delivery_id = #{deliveryId}
            </if>
            <if test="deliveryTime != null">
                and delivery_time = #{deliveryTime}
            </if>
            <if test="vendor != null and vendor != ''">
                and vendor = #{vendor}
            </if>
            <if test="buyer != null and buyer != ''">
                and buyer = #{buyer}
            </if>
            <if test="payables != null">
                and payables = #{payables}
            </if>
            <if test="paid != null">
                and paid = #{paid}
            </if>
            <if test="unpaid != null">
                and unpaid = #{unpaid}
            </if>
            <if test="remarks != null and remarks != ''">
                and remarks = #{remarks}
            </if>
            <if test="founder != null and founder != ''">
                and founder = #{founder}
            </if>
            <if test="caseState != null">
                and case_state = #{caseState}
            </if>
            <if test="paymentRemark != null and paymentRemark != ''">
                and payment_remark = #{paymentRemark}
            </if>
            <if test="lastCollectionTime != null">
                and last_collection_time = #{lastCollectionTime}
            </if>
        </where>
    </select>

    <!--通过实体作为筛选条件查询-->
    <select id="queryAllByPage" resultMap="CapitalPayableMap">
        select a.*,b.vendor_name from capital_payable a INNER JOIN base_vendor b on a.vendor=b.vendor_id
        <where>
            <if test="deliveryId != null and deliveryId != ''">
                and delivery_id like CONCAT('%',#{deliveryId},'%')
            </if>
            <if test="deliveryTime != null and deliveryTime=='今天'" >
                and to_days(delivery_time) = to_days(now())
            </if>
            <if test="deliveryTime != null and deliveryTime=='昨天'" >
                and to_days(now())-to_days(delivery_time) = 1
            </if>
            <if test="deliveryTime != null and deliveryTime=='本周'" >
                and DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(delivery_time)
            </if>
            <if test="deliveryTime != null and deliveryTime=='本月'" >
                and DATE_FORMAT( delivery_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' )
            </if>

            <if test="deliveryTime != null and deliveryTime != '' and deliveryTime=='自定义' and otimeState!=null and otimeEnd!=null">
                and DATE_FORMAT(delivery_time,'%Y-%m-%d') BETWEEN DATE_FORMAT(#{otimeState},'%Y-%m-%d')
                AND DATE_FORMAT(#{otimeEnd},'%Y-%m-%d')
            </if>

            <if test="lastCollectionTime != null and lastCollectionTime=='今天'" >
                and to_days(last_collection_time) = to_days(now())
            </if>
            <if test="lastCollectionTime != null and lastCollectionTime=='昨天'" >
                and to_days(now())-to_days(last_collection_time) = 1
            </if>
            <if test="lastCollectionTime != null and lastCollectionTime=='本周'" >
                and DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(last_collection_time)
            </if>
            <if test="lastCollectionTime != null and lastCollectionTime=='本月'" >
                and DATE_FORMAT( last_collection_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' )
            </if>
            <if test="lastCollectionTime != null and lastCollectionTime != '' and lastCollectionTime=='自定义' and dtimeState!=null and dtimeEnd!=null">
                and DATE_FORMAT(last_collection_time,'%Y-%m-%d') BETWEEN DATE_FORMAT(#{dtimeState},'%Y-%m-%d')
                AND DATE_FORMAT(#{dtimeEnd},'%Y-%m-%d')
            </if>
            <if test="vendor != null and vendor !=''">
                and vendor = #{vendor}
            </if>
            <if test="buyer != null and buyer !=''">
                and buyer = #{buyer}
            </if>
            <if test="founder != null and founder !=''">
                and founder = #{founder}
            </if>
            <if test="caseState != null and caseState == '未结案'" >
                and case_state = 0
            </if>
            <if test="caseState != null and caseState == '结案'" >
                and case_state = 1
            </if>
        </where>
        ORDER BY delivery_time DESC
    </select>
    <!--新增所有列-->
    <insert id="insert" keyProperty="deliveryId" useGeneratedKeys="true">
        insert into frameproject.capital_payable(delivery_id,delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder, case_state, payment_remark, last_collection_time)
        values (#{deliveryId},#{deliveryTime}, #{vendor}, #{buyer}, #{payables}, #{paid}, #{unpaid}, #{remarks}, #{founder}, #{caseState}, #{paymentRemark}, #{lastCollectionTime})
    </insert>

    <insert id="insertBatch" keyProperty="deliveryId" useGeneratedKeys="true">
        insert into frameproject.capital_payable(delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder,
        case_state, payment_remark, last_collection_time)
        values
        <foreach collection="entities" item="entity" separator=",">
            (#{entity.deliveryTime}, #{entity.vendor}, #{entity.buyer}, #{entity.payables}, #{entity.paid},
            #{entity.unpaid}, #{entity.remarks}, #{entity.founder}, #{entity.caseState}, #{entity.paymentRemark},
            #{entity.lastCollectionTime})
        </foreach>
    </insert>

    <insert id="insertOrUpdateBatch" keyProperty="deliveryId" useGeneratedKeys="true">
        insert into frameproject.capital_payable(delivery_time, vendor, buyer, payables, paid, unpaid, remarks, founder,
        case_state, payment_remark, last_collection_time)
        values
        <foreach collection="entities" item="entity" separator=",">
            (#{entity.deliveryTime}, #{entity.vendor}, #{entity.buyer}, #{entity.payables}, #{entity.paid},
            #{entity.unpaid}, #{entity.remarks}, #{entity.founder}, #{entity.caseState}, #{entity.paymentRemark},
            #{entity.lastCollectionTime})
        </foreach>
        on duplicate key update
        delivery_time = values(delivery_time) , vendor = values(vendor) , buyer = values(buyer) , payables =
        values(payables) , paid = values(paid) , unpaid = values(unpaid) , remarks = values(remarks) , founder =
        values(founder) , case_state = values(case_state) , payment_remark = values(payment_remark) ,
        last_collection_time = values(last_collection_time)
    </insert>

    <!--通过主键修改数据-->
    <update id="update">
        update frameproject.capital_payable
        <set>
            <if test="deliveryTime != null">
                delivery_time = #{deliveryTime},
            </if>
            <if test="vendor != null and vendor != ''">
                vendor = #{vendor},
            </if>
            <if test="buyer != null and buyer != ''">
                buyer = #{buyer},
            </if>
            <if test="payables != null">
                payables = #{payables},
            </if>
            <if test="paid != null">
                paid = #{paid},
            </if>
            <if test="unpaid != null">
                unpaid = #{unpaid},
            </if>
            <if test="remarks != null and remarks != ''">
                remarks = #{remarks},
            </if>
            <if test="founder != null and founder != ''">
                founder = #{founder},
            </if>
            <if test="caseState != null">
                case_state = #{caseState},
            </if>
            <if test="paymentRemark != null and paymentRemark != ''">
                payment_remark = #{paymentRemark},
            </if>
            <if test="lastCollectionTime != null">
                last_collection_time = #{lastCollectionTime},
            </if>
        </set>
        where delivery_id = #{deliveryId}
    </update>

    <!--通过主键删除-->
    <delete id="deleteById">
        delete from frameproject.capital_payable where delivery_id = #{deliveryId}
    </delete>

</mapper>

