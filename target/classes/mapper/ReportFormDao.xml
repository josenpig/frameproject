<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xingji.frameproject.mybatis.dao.ReportFormDao">

    <resultMap type="com.xingji.frameproject.vo.FundAccountsStatisticsVo" id="FundAccountsStatisticsVoMap">
        <result property="capitalId" column="capital_id" jdbcType="VARCHAR"/>
        <result property="fundAccount" column="fund_account" jdbcType="VARCHAR"/>
        <result property="initialAmount" column="initial_amount" jdbcType="NUMERIC"/>
        <result property="currentAmount" column="current_amount" jdbcType="NUMERIC"/>
        <result property="state" column="state" jdbcType="INTEGER"/>
        <result property="settlementTypeId" column="settlement_type_id" jdbcType="INTEGER"/>
        <result property="settlementType" column="settlement_type" jdbcType="VARCHAR"/>
        <result property="paymentMoney" column="SUM(pa.this_money)" jdbcType="VARCHAR"/>
        <result property="receiptMoney" column="SUM(ra.this_money)" jdbcType="VARCHAR"/>
        <result property="startTime" column="" jdbcType="TIMESTAMP"/>
        <result property="endTime" column="" jdbcType="TIMESTAMP"/>
    </resultMap>

    <select id="fundAllFundAccountsStatisticsVo" resultMap="FundAccountsStatisticsVoMap">
        SELECT ca.*,st.settlement_type,SUM(pa.this_money),SUM(ra.this_money),p.payment_time,r.receipt_time
        FROM  `base_capital_account` ca
        LEFT JOIN (SELECT payment_id,fund_account, SUM(this_money) AS this_money FROM capital_payment_account GROUP BY fund_account) AS pa ON pa.fund_account = ca.capital_id
        LEFT JOIN (SELECT receipt_id,fund_account, SUM(this_money) AS this_money FROM capital_receipt_account GROUP BY fund_account) AS ra ON ra.fund_account = ca.capital_id
        LEFT JOIN `base_settlement_type` st ON st.id = ca.settlement_type_id
        LEFT JOIN `capital_payment` p ON pa.payment_id=p.payment_id
        LEFT JOIN `capital_receipt` r ON r.receipt_id=ra.receipt_id
        <where>
            <if test="startTime != null and endTime != null">
                payment_time BETWEEN  #{startTime} AND #{endTime}
                or receipt_time BETWEEN  #{startTime} AND #{endTime}
            </if>
        </where>
        GROUP BY ca.capital_id
    </select>

    <select id="fundAllRsum" resultType="java.lang.Double">
        SELECT SUM(ra.this_money) FROM  `base_capital_account` ca
        LEFT JOIN `capital_receipt_account` ra ON ra.fund_account = ca.capital_id
        LEFT JOIN `capital_receipt` r ON r.receipt_id=ra.receipt_id
        <where>
            <if test="param1  != null and param2  != null">
                receipt_time BETWEEN  #{param1} AND #{param2}
            </if>
        </where>
    </select>

    <select id="fundAllPsum" resultType="java.lang.Double">
        SELECT SUM(pa.this_money) FROM  `base_capital_account` ca
        LEFT JOIN `capital_payment_account` pa ON pa.fund_account = ca.capital_id
        LEFT JOIN `capital_payment` p ON pa.payment_id=p.payment_id
        <where>
            <if test="param1  != null and param2  != null">
            AND payment_time BETWEEN  #{param1} AND #{param2}
        </if>
        </where>
        AND p.approval_state=1
    </select>
</mapper>

